# 集成示例工程

## 概述

为方便验证 SDK 与 Unity 集成、三种工程模板（Objc/Swift/SwiftUI）的使用方式，仓库内提供多 Target 示例工程 `UnifiedExample/`。

## 目录结构

```
UnifiedExample/
├── ObjcExample/           # Objective-C 示例
├── SwiftExample/          # Swift 示例（UIKit）
├── SwiftUIExample/        # SwiftUI 示例
├── UnityProject/          # Unity iOS 子工程目录
├── README.md              # 该示例的详细使用说明
├── Podfile                # 依赖管理文件
└── scripts/               # 脚本文件
    └── gen_project.rb     # 项目生成脚本
```

### 示例项目说明

- **ObjcExample**：Objective-C 示例项目，展示如何在 Objective-C 项目中集成 GrowthSDK
- **SwiftExample**：Swift UIKit 示例项目，展示在传统 UIKit 项目中的集成方式
- **SwiftUIExample**：SwiftUI 示例项目，展示在现代 SwiftUI 项目中的集成方式
- **UnityProject**：Unity iOS 子工程目录（发布仓库完全忽略该目录；请在本地手动新建 `UnityProject/` 并将 Unity 导出的 iOS 工程拷入）

## 准备与首次打开

### 1. 创建 Unity 工程目录

先在本地创建并导入 Unity 工程：

```bash
cd UnifiedExample
mkdir -p UnityProject
# 将你本地 Unity 导出的 iOS 工程完整复制到 UnityProject/
```

### 2. 安装依赖并打开

```bash
cd UnifiedExample
pod install
open UnifiedExample.xcworkspace
```

### 3. 选择运行目标

在 Xcode 顶部 Scheme 中选择任一 Target 运行：
- `ObjcExample`
- `SwiftExample`
- `SwiftUIExample`

## Unity 引入（重要）

由于 Unity 子项目自动化配置较复杂，示例已预置子项目引用；但仍需在每个 App Target 手动完成以下操作：

### 1. 添加 UnityFramework

1. 进入 Target → General → Frameworks, Libraries, and Embedded Content
2. 确保你已将 Unity iOS 导出工程复制至 `UnifiedExample/UnityProject/`，并能看到 `Unity-iPhone.xcodeproj`
3. 点击"+"，在 `Unity-iPhone.xcodeproj` → Products 下添加 `UnityFramework.framework`
4. 将其设置为"Embed & Sign"

### 2. 验证配置

完成后即可在三个示例中统一使用 Unity 视图（SDK 内部提供 `GrowthKit.createController` 与 `createView`）。

## Info.plist 必要项（示例已预置）

### 基本配置

示例项目已预置以下必要配置：

- `CFBundleIdentifier`
- `CFBundleVersion`
- `CFBundleShortVersionString`
- `CFBundleExecutable`
- `CFBundleDisplayName/Name`

### 启动屏配置

示例工程已设置 Launch Screen：

- **ObjcExample/SwiftExample**：`UILaunchStoryboardName = LaunchScreen`
- **SwiftUIExample**：同样使用 Launch Screen（或 `UILaunchScreen`）

## 示例项目详解

### Objective-C 示例

#### 项目结构

```
ObjcExample/
├── AppDelegate.h/m        # 应用代理
├── ViewController.h/m     # 主视图控制器
├── GrowthKitConfig.h      # SDK 配置头文件
├── Assets.xcassets/       # 资源文件
├── Base.lproj/           # 本地化文件
└── Info.plist            # 配置文件
```

#### 关键代码

**AppDelegate.m**
```objective-c
#import <GrowthSDK/GrowthSDK-Swift.h>

- (void)initializeGrowthKitSDK:(NSDictionary *)launchOptions {
    NSArray<ConfigKeyItem *> *configKeys = @[
        [[ConfigKeyItem alloc] initWithAdjustKey:@"your_adjust_key"],
        [[ConfigKeyItem alloc] initWithConfigKey:@"your_config_key"],
        [[ConfigKeyItem alloc] initWithAdUnitKey:@"your_adunit_key"]
    ];

    NetworkConfig *config = [[NetworkConfig alloc] initWithServiceId:@"your_service_id"
                                                         bundleName:@"com.example.app"
                                                         serviceUrl:@"https://api.example.com"
                                                         serviceKey:@"your_service_key"
                                                          serviceIv:@"your_service_iv"
                                                          publicKey:@"your_public_key"
                                                     configKeyItems:configKeys
                                                              other:nil];

    [[GrowthKit shared] initializeWith:config launchOptions:launchOptions completion:^(NSError * _Nullable error) {
        dispatch_async(dispatch_get_main_queue(), ^{
            if (error) {
                NSLog(@"SDK 初始化失败: %@", error.localizedDescription);
            } else {
                NSLog(@"SDK 初始化成功");
            }
        });
    }];
}
```

**ViewController.m**
```objective-c
#import <GrowthSDK/GrowthSDK-Swift.h>

@interface ViewController () <AdCallbacks>
@end

@implementation ViewController

- (IBAction)showRewardedAd:(id)sender {
    [GrowthKit showAdWithStyle:ADStyleRewarded callbacks:self];
}

- (IBAction)showInterstitialAd:(id)sender {
    [GrowthKit showAdWithStyle:ADStyleInserted callbacks:self];
}

// MARK: - AdCallbacks
- (void)onStartLoading:(ADStyle)style {
    NSLog(@"广告开始加载: %ld", (long)style);
}

- (void)onLoadSuccess:(ADStyle)style {
    NSLog(@"广告加载成功: %ld", (long)style);
}

- (void)onGetAdReward:(ADStyle)style {
    NSLog(@"用户获得奖励: %ld", (long)style);
}

- (void)onAdClose:(ADStyle)style {
    NSLog(@"广告关闭: %ld", (long)style);
}

@end
```

### Swift UIKit 示例

#### 项目结构

```
SwiftExample/
├── AppDelegate.swift      # 应用代理
├── ViewController.swift   # 主视图控制器
├── Assets.xcassets/       # 资源文件
├── Base.lproj/           # 本地化文件
└── Info.plist            # 配置文件
```

#### 关键代码

**AppDelegate.swift**
```swift
import UIKit
import GrowthSDK

struct CustomNetworkConfig: NetworkConfigurable {
    let serviceId: String = "your_service_id"
    let bundleName: String = "com.example.app"
    let serviceUrl: String = "https://api.example.com"
    let publicKey: String = "your_public_key"
    let serviceKey: String = "your_service_key"
    let serviceIv: String = "your_service_iv"
    var configKeyItems: [ConfigKeyItem]? {
        [
            ConfigKeyItem(adjustKey: "your_adjust_key"),
            ConfigKeyItem(configKey: "your_config_key"),
            ConfigKeyItem(adUnitKey: "your_adunit_key")
        ]
    }
}

@main
class AppDelegate: UIResponder, UIApplicationDelegate {
    func application(_ application: UIApplication,
                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        Task {
            do {
                try await GrowthKit.shared.initialize(with: CustomNetworkConfig())
                print("SDK 初始化成功")
            } catch {
                print("SDK 初始化失败: \(error)")
            }
        }
        return true
    }
}
```

**ViewController.swift**
```swift
import UIKit
import GrowthSDK

class ViewController: UIViewController, AdCallbacks {
    
    @IBAction func showRewardedAd(_ sender: Any) {
        GrowthKit.showAd(with: .rewarded, callbacks: self)
    }
    
    @IBAction func showInterstitialAd(_ sender: Any) {
        GrowthKit.showAd(with: .inserted, callbacks: self)
    }
}

// MARK: - AdCallbacks
extension ViewController {
    
    func onStartLoading(_ style: ADStyle) {
        print("广告开始加载: \(style)")
    }
    
    func onLoadSuccess(_ style: ADStyle) {
        print("广告加载成功: \(style)")
    }
    
    func onGetAdReward(_ style: ADStyle) {
        print("用户获得奖励: \(style)")
    }
    
    func onAdClose(_ style: ADStyle) {
        print("广告关闭: \(style)")
    }
}
```

### SwiftUI 示例

#### 项目结构

```
SwiftUIExample/
├── AppDelegate.swift      # 应用代理
├── ContentView.swift      # 主内容视图
├── Assets.xcassets/       # 资源文件
├── Base.lproj/           # 本地化文件
└── Info.plist            # 配置文件
```

#### 关键代码

**AppDelegate.swift**
```swift
import SwiftUI
import GrowthSDK
import UIKit

struct CustomNetworkConfig: NetworkConfigurable {
    let serviceId: String = "your_service_id"
    let bundleName: String = "com.example.app"
    let serviceUrl: String = "https://api.example.com"
    let publicKey: String = "your_public_key"
    let serviceKey: String = "your_service_key"
    let serviceIv: String = "your_service_iv"
    var configKeyItems: [ConfigKeyItem]? {
        [
            ConfigKeyItem(adjustKey: "your_adjust_key"),
            ConfigKeyItem(configKey: "your_config_key"),
            ConfigKeyItem(adUnitKey: "your_adunit_key")
        ]
    }
}

class AppDelegate: NSObject, UIApplicationDelegate {
    func application(_ application: UIApplication,
                     didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey : Any]? = nil) -> Bool {
        Task {
            do {
                try await GrowthKit.shared.initialize(with: CustomNetworkConfig())
                print("SDK 初始化成功")
            } catch {
                print("SDK 初始化失败: \(error)")
            }
        }
        return true
    }
}

@main
struct YourApp: App {
    @UIApplicationDelegateAdaptor(AppDelegate.self) var delegate

    var body: some Scene {
        WindowGroup {
            ContentView()
        }
    }
}
```

**ContentView.swift**
```swift
import SwiftUI
import GrowthSDK

struct ContentView: View {
    @StateObject private var adManager = AdManager()
    
    var body: some View {
        VStack(spacing: 20) {
            Text("GrowthSDK SwiftUI 示例")
                .font(.title)
                .padding()
            
            Button("展示激励广告") {
                adManager.showRewardedAd()
            }
            .buttonStyle(.borderedProminent)
            
            Button("展示插屏广告") {
                adManager.showInterstitialAd()
            }
            .buttonStyle(.bordered)
        }
        .padding()
    }
}

class AdManager: NSObject, ObservableObject, AdCallbacks {
    
    func showRewardedAd() {
        GrowthKit.showAd(with: .rewarded, callbacks: self)
    }
    
    func showInterstitialAd() {
        GrowthKit.showAd(with: .inserted, callbacks: self)
    }
}

// MARK: - AdCallbacks
extension AdManager {
    
    func onStartLoading(_ style: ADStyle) {
        print("广告开始加载: \(style)")
    }
    
    func onLoadSuccess(_ style: ADStyle) {
        print("广告加载成功: \(style)")
    }
    
    func onGetAdReward(_ style: ADStyle) {
        print("用户获得奖励: \(style)")
    }
    
    func onAdClose(_ style: ADStyle) {
        print("广告关闭: \(style)")
    }
}
```

## Unity 集成示例

### Unity 视图管理（UIKit）

```swift
import UIKit
import GrowthSDK

class SceneDelegate: UIResponder, UIWindowSceneDelegate {
    var window: UIWindow?

    func scene(_ scene: UIScene, willConnectTo session: UISceneSession, options connectionOptions: UIScene.ConnectionOptions) {
        guard let windowScene = (scene as? UIWindowScene) else { return }
        window = UIWindow(windowScene: windowScene)
        initializeUnityAndSetupRoot()
    }

    private func initializeUnityAndSetupRoot() {
        Task {
            do {
                let unityController = try await UnityManager.shared.initializeUnity()
                await MainActor.run {
                    let host = GrowthKit.createController(with: unityController)
                    self.window?.rootViewController = host
                    self.window?.makeKeyAndVisible()
                }
            } catch {
                print("[app] Unity 初始化失败: \(error)")
            }
        }
    }
}
```

### SwiftUI 集成 Unity 视图

```swift
import SwiftUI
import GrowthSDK

struct ContentView: View {
    @State private var unityController: UIViewController?

    var body: some View {
        Group {
            if let controller = unityController {
                GrowthKit.createView(with: controller)
                    .ignoresSafeArea()
            } else {
                Color("launch").ignoresSafeArea()
            }
        }
        .onAppear { initializeUnity() }
    }

    private func initializeUnity() {
        Task {
            do {
                let controller = try await UnityManager.shared.initializeUnity()
                self.unityController = controller
            } catch {
                print("[app] Unity 初始化失败: \(error)")
            }
        }
    }
}
```

## 常见问题

### 设备安装失败（invalid bundle / 缺键）

**原因**：Info.plist 缺少必要配置

**处理**：
- 检查 Info.plist 是否包含 `CFBundleIdentifier/CFBundleExecutable` 等必备键
- 清理（Product → Clean Build Folder）
- 卸载设备上旧 App 后重装

### 找不到 UnityFramework

**原因**：UnityFramework 未正确配置

**处理**：
- 确认已在每个 Target 中添加并设置为"Embed & Sign"
- 检查 Unity 工程是否正确导出

### 编译错误

**处理**：
- 确保使用 `.xcworkspace` 文件打开项目
- 运行 `pod install` 更新依赖
- 清理并重新构建项目

## 一键生成

如需重新生成示例工程，可以使用提供的脚本：

```bash
cd UnifiedExample
ruby scripts/gen_project.rb
pod install
open UnifiedExample.xcworkspace
```

## 自定义配置

### 修改配置参数

在每个示例项目中，找到配置相关的文件：

- **ObjcExample**: `GrowthKitConfig.h`
- **SwiftExample**: `AppDelegate.swift` 中的 `CustomNetworkConfig`
- **SwiftUIExample**: `AppDelegate.swift` 中的 `CustomNetworkConfig`

修改相应的配置参数：

```swift
struct CustomNetworkConfig: NetworkConfigurable {
    let serviceId: String = "your_actual_service_id"
    let bundleName: String = Bundle.main.bundleIdentifier ?? "com.example.app"
    let serviceUrl: String = "https://your_actual_api.com"
    let publicKey: String = "your_actual_public_key"
    let serviceKey: String = "your_actual_service_key"
    let serviceIv: String = "your_actual_service_iv"
    var configKeyItems: [ConfigKeyItem]? {
        [
            ConfigKeyItem(adjustKey: "your_actual_adjust_key"),
            ConfigKeyItem(configKey: "your_actual_config_key"),
            ConfigKeyItem(adUnitKey: "your_actual_adunit_key")
        ]
    }
}
```

### 添加自定义功能

可以在示例项目的基础上添加自定义功能：

1. **添加新的广告类型**
2. **实现自定义回调处理**
3. **添加错误处理和重试机制**
4. **集成其他第三方服务**

## 测试建议

### 功能测试

1. **SDK 初始化测试**
   - 验证初始化成功/失败场景
   - 测试配置参数错误情况

2. **广告展示测试**
   - 测试各种广告类型
   - 验证回调函数正确触发
   - 测试广告加载失败情况

3. **Unity 集成测试**
   - 验证 Unity 视图正确显示
   - 测试视图控制器生命周期
   - 验证内存管理

### 性能测试

1. **启动性能**
   - 测量 SDK 初始化时间
   - 监控内存使用情况

2. **广告性能**
   - 测试广告加载时间
   - 监控网络请求性能

3. **内存管理**
   - 检查内存泄漏
   - 验证资源正确释放

## 相关文档

- [SDK 集成指南](SDK_集成指南.md) - 详细的集成步骤
- [SDK 初始化指南](SDK_初始化指南.md) - 初始化配置和示例
- [广告集成指南](广告集成指南.md) - 广告功能集成
- [API 参考文档](API_参考文档.md) - 完整的 API 接口
- [错误处理指南](错误处理指南.md) - 错误码和处理方法

# 错误处理指南

## 概述

本文档详细介绍 GrowthSDK 中可能遇到的错误类型、错误码和处理方法，帮助开发者快速定位和解决问题。

## 错误类型分类

### 初始化错误

初始化阶段的错误类型：

- **InitError.alreadyInitialized**: 重复初始化
- **InitError.storageInitFailed(String)**: 数据存储初始化失败
- **InitError.serviceInitFailed(String)**: 任务/服务初始化失败

### 广告错误

广告阶段的错误通过 `AdCallbacks` 的 `onLoadFailed` / `onShowFailed` 返回：

- **AdError.noFill**: 无广告填充
- **AdError.networkError**: 网络错误
- **AdError.timeout**: 请求超时

## 错误处理示例

### 初始化错误处理

```swift
do {
    try await GrowthKit.shared.initialize(with: config)
    print("SDK 初始化成功")
} catch let error as InitError {
    switch error {
    case .alreadyInitialized:
        print("SDK 已经初始化")
        // 可以继续使用 SDK
    case .storageInitFailed(let message):
        print("存储初始化失败: \(message)")
        // 检查存储权限或磁盘空间
        handleStorageInitFailure(message: message)
    case .serviceInitFailed(let message):
        print("服务初始化失败: \(message)")
        // 检查网络连接或服务配置
        handleServiceInitFailure(message: message)
    }
} catch {
    print("未知错误: \(error)")
    // 处理其他未知错误
}
```

### 广告错误处理

```swift
extension AdManager: AdCallbacks {
    
    func onLoadFailed(_ style: ADStyle, error: Error?) {
        print("广告加载失败: \(style), 错误: \(error?.localizedDescription ?? "未知")")
        
        guard let error = error else {
            handleUnknownAdError(style: style)
            return
        }
        
        switch error {
        case let adError as AdError:
            handleAdError(adError, style: style)
        default:
            handleUnknownAdError(style: style, error: error)
        }
    }
    
    func onShowFailed(_ style: ADStyle, error: Error?) {
        print("广告展示失败: \(style), 错误: \(error?.localizedDescription ?? "未知")")
        
        guard let error = error else {
            handleUnknownShowError(style: style)
            return
        }
        
        switch error {
        case let adError as AdError:
            handleAdError(adError, style: style)
        default:
            handleUnknownShowError(style: style, error: error)
        }
    }
    
    private func handleAdError(_ error: AdError, style: ADStyle) {
        switch error {
        case .noFill:
            print("无广告填充: \(style)")
            handleNoFill(style: style)
        case .networkError:
            print("网络错误: \(style)")
            handleNetworkError(style: style)
        case .timeout:
            print("请求超时: \(style)")
            handleTimeout(style: style)
        }
    }
}
```

## 具体错误处理方法

### 存储初始化失败

```swift
private func handleStorageInitFailure(message: String) {
    // 检查存储权限
    checkStoragePermissions()
    
    // 检查磁盘空间
    checkDiskSpace()
    
    // 尝试清理缓存
    clearCache()
    
    // 重试初始化
    retryInitialization()
}

private func checkStoragePermissions() {
    // 检查应用是否有存储权限
    // 在 iOS 中，应用沙盒内的存储通常不需要特殊权限
    // 但可以检查是否有足够的磁盘空间
}

private func checkDiskSpace() {
    // 检查可用磁盘空间
    let fileManager = FileManager.default
    if let attributes = try? fileManager.attributesOfFileSystem(forPath: NSHomeDirectory()) {
        if let freeSpace = attributes[.systemFreeSize] as? Int64 {
            let freeSpaceMB = freeSpace / 1024 / 1024
            print("可用磁盘空间: \(freeSpaceMB) MB")
            
            if freeSpaceMB < 100 {
                print("磁盘空间不足，建议清理")
            }
        }
    }
}

private func clearCache() {
    // 清理应用缓存
    let cacheURL = FileManager.default.urls(for: .cachesDirectory, in: .userDomainMask).first
    if let cacheURL = cacheURL {
        try? FileManager.default.removeItem(at: cacheURL)
        print("缓存已清理")
    }
}
```

### 服务初始化失败

```swift
private func handleServiceInitFailure(message: String) {
    // 检查网络连接
    checkNetworkConnection()
    
    // 检查服务配置
    checkServiceConfiguration()
    
    // 重试初始化
    retryInitialization()
}

private func checkNetworkConnection() {
    // 检查网络连接状态
    let reachability = try? Reachability()
    
    reachability?.whenReachable = { reachability in
        print("网络已连接: \(reachability.connection)")
        // 网络恢复后重试初始化
        self.retryInitialization()
    }
    
    reachability?.whenUnreachable = { _ in
        print("网络连接失败")
        // 显示网络错误提示
        self.showNetworkErrorAlert()
    }
    
    try? reachability?.startNotifier()
}

private func checkServiceConfiguration() {
    // 检查服务配置是否正确
    // 验证 serviceId, serviceUrl 等配置参数
    print("检查服务配置...")
}
```

### 无广告填充处理

```swift
private func handleNoFill(style: ADStyle) {
    print("处理无广告填充: \(style)")
    
    // 记录无填充事件
    logNoFillEvent(style: style)
    
    // 尝试其他广告网络
    tryAlternativeAdNetworks(style: style)
    
    // 显示备用内容
    showFallbackContent(style: style)
    
    // 延迟重试
    scheduleRetry(style: style)
}

private func logNoFillEvent(style: ADStyle) {
    // 记录无填充事件用于分析
    let event = [
        "type": "no_fill",
        "style": "\(style)",
        "timestamp": Date().timeIntervalSince1970
    ] as [String : Any]
    
    // 发送到分析服务
    AnalyticsService.logEvent(event)
}

private func tryAlternativeAdNetworks(style: ADStyle) {
    // 尝试其他广告网络
    // 这通常由 SDK 内部处理
    print("尝试其他广告网络")
}

private func showFallbackContent(style: ADStyle) {
    // 显示备用内容，如游戏内奖励或提示
    switch style {
    case .rewarded:
        showInGameReward()
    case .inserted:
        showGameContent()
    case .appOpen:
        // 开屏广告通常不需要备用内容
        break
    }
}

private func scheduleRetry(style: ADStyle) {
    // 延迟重试广告加载
    DispatchQueue.main.asyncAfter(deadline: .now() + 30) {
        print("重试加载广告: \(style)")
        GrowthKit.showAd(with: style, callbacks: self)
    }
}
```

### 网络错误处理

```swift
private func handleNetworkError(style: ADStyle) {
    print("处理网络错误: \(style)")
    
    // 检查网络连接
    checkNetworkConnection()
    
    // 显示网络错误提示
    showNetworkErrorAlert()
    
    // 延迟重试
    scheduleRetry(style: style)
}

private func showNetworkErrorAlert() {
    let alert = UIAlertController(
        title: "网络错误",
        message: "请检查网络连接后重试",
        preferredStyle: .alert
    )
    
    alert.addAction(UIAlertAction(title: "确定", style: .default))
    
    // 显示提示
    if let topViewController = UIApplication.shared.keyWindow?.rootViewController {
        topViewController.present(alert, animated: true)
    }
}
```

### 超时错误处理

```swift
private func handleTimeout(style: ADStyle) {
    print("处理超时错误: \(style)")
    
    // 增加超时时间
    increaseTimeout()
    
    // 显示超时提示
    showTimeoutAlert()
    
    // 延迟重试
    scheduleRetry(style: style)
}

private func increaseTimeout() {
    // 增加网络请求超时时间
    // 这通常需要在网络配置中设置
    print("增加超时时间")
}

private func showTimeoutAlert() {
    let alert = UIAlertController(
        title: "请求超时",
        message: "网络请求超时，请稍后重试",
        preferredStyle: .alert
    )
    
    alert.addAction(UIAlertAction(title: "确定", style: .default))
    
    // 显示提示
    if let topViewController = UIApplication.shared.keyWindow?.rootViewController {
        topViewController.present(alert, animated: true)
    }
}
```

## 错误恢复策略

### 重试机制

```swift
class ErrorRecoveryManager {
    
    private var retryCount = 0
    private let maxRetryCount = 3
    private let retryDelay: TimeInterval = 5.0
    
    func retryInitialization() {
        guard retryCount < maxRetryCount else {
            print("达到最大重试次数")
            showFinalErrorAlert()
            return
        }
        
        retryCount += 1
        print("重试初始化，第 \(retryCount) 次")
        
        DispatchQueue.main.asyncAfter(deadline: .now() + retryDelay) {
            Task {
                do {
                    try await GrowthKit.shared.initialize(with: self.config)
                    print("重试初始化成功")
                    self.retryCount = 0 // 重置重试计数
                } catch {
                    print("重试初始化失败: \(error)")
                    self.retryInitialization()
                }
            }
        }
    }
    
    func retryAdLoad(style: ADStyle) {
        guard retryCount < maxRetryCount else {
            print("达到最大重试次数")
            return
        }
        
        retryCount += 1
        print("重试加载广告，第 \(retryCount) 次")
        
        DispatchQueue.main.asyncAfter(deadline: .now() + retryDelay) {
            GrowthKit.showAd(with: style, callbacks: self)
        }
    }
    
    private func showFinalErrorAlert() {
        let alert = UIAlertController(
            title: "初始化失败",
            message: "SDK 初始化失败，请重启应用或联系技术支持",
            preferredStyle: .alert
        )
        
        alert.addAction(UIAlertAction(title: "确定", style: .default))
        
        if let topViewController = UIApplication.shared.keyWindow?.rootViewController {
            topViewController.present(alert, animated: true)
        }
    }
}
```

### 降级策略

```swift
class FallbackManager {
    
    func handleAdFailure(style: ADStyle) {
        switch style {
        case .rewarded:
            // 激励广告失败时，直接给予奖励
            giveRewardDirectly()
        case .inserted:
            // 插屏广告失败时，跳过广告
            skipInterstitial()
        case .appOpen:
            // 开屏广告失败时，直接进入应用
            proceedToApp()
        }
    }
    
    private func giveRewardDirectly() {
        print("直接给予奖励")
        // 实现直接给予奖励的逻辑
    }
    
    private func skipInterstitial() {
        print("跳过插屏广告")
        // 实现跳过插屏广告的逻辑
    }
    
    private func proceedToApp() {
        print("直接进入应用")
        // 实现直接进入应用的逻辑
    }
}
```

## 错误监控和报告

### 错误日志记录

```swift
class ErrorLogger {
    
    static func logError(_ error: Error, context: String) {
        let errorInfo = [
            "error": error.localizedDescription,
            "context": context,
            "timestamp": Date().timeIntervalSince1970,
            "sdk_version": GrowthKit.sdkVersion,
            "device_info": getDeviceInfo()
        ] as [String : Any]
        
        // 记录到本地日志
        print("错误日志: \(errorInfo)")
        
        // 发送到远程服务
        sendErrorReport(errorInfo)
    }
    
    private static func getDeviceInfo() -> [String: Any] {
        return [
            "model": UIDevice.current.model,
            "system_version": UIDevice.current.systemVersion,
            "app_version": Bundle.main.infoDictionary?["CFBundleShortVersionString"] as? String ?? "unknown"
        ]
    }
    
    private static func sendErrorReport(_ errorInfo: [String: Any]) {
        // 发送错误报告到远程服务
        // 这里可以实现具体的上报逻辑
    }
}
```

## 最佳实践

### 1. 错误处理原则

- **及时处理**：不要忽略错误，及时处理并记录
- **用户友好**：向用户显示友好的错误提示
- **降级策略**：提供备用方案，确保用户体验
- **监控报告**：记录错误信息，便于分析和改进

### 2. 错误预防

- **参数验证**：在使用 API 前验证参数
- **状态检查**：确保 SDK 已正确初始化
- **网络检查**：在发起网络请求前检查网络状态
- **权限检查**：确保应用有必要的权限

### 3. 调试技巧

- **启用日志**：在开发阶段启用详细日志
- **错误分类**：根据错误类型采用不同的处理策略
- **重试机制**：实现合理的重试机制
- **降级方案**：为关键功能提供降级方案

## 相关文档

- [SDK 初始化指南](SDK_初始化指南.md) - 初始化配置和错误处理
- [广告集成指南](广告集成指南.md) - 广告错误处理
- [API 参考文档](API_参考文档.md) - 完整的 API 接口
